## üì¶ –ß—Ç–æ —Ç–∞–∫–æ–µ Rc<T>?

`Rc<T>` ‚Äî —ç—Ç–æ —É–º–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å —Å –ø–æ–¥—Å—á—ë—Ç–æ–º —Å—Å—ã–ª–æ–∫, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–º:

- –ù–µ—Å–∫–æ–ª—å–∫–æ `Rc<T>` –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç.
- –ö–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è `Rc` —É–¥–∞–ª—è–µ—Ç—Å—è ‚Äî –æ–±—ä–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–æ–º –∫–æ–¥–µ (`!Send`, `!Sync`).
- –°–æ–≤–º–µ—Å—Ç–∏–º —Å `RefCell<T>` –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç–∏.

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ø—Å–µ–≤–¥–æ–∫–æ–¥)
```rust
struct RcBox<T> {
    strong: Cell<usize>,  // —Å—á—ë—Ç—á–∏–∫, —Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω—ã—Ö (Rc<T>) –∂–∏–≤–æ
    weak: Cell<usize>,  // —Å—á—ë—Ç—á–∏–∫, —Å–∫–æ–ª—å–∫–æ —Å–ª–∞–±—ã—Ö (Weak<T>) —Å—Å—ã–ª–æ–∫ –∂–∏–≤–æ
    value: T,  // —Å–∞–º–æ –∑–Ω–∞—á–µ–Ω–∏–µ T
}

pub struct Rc<T> {
    ptr: *const RcBox<T>,
}

```

- `Cell` ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–∑–º–µ–Ω—è–µ–º–æ—Å—Ç—å –±–µ–∑ &mut
- `*const` ‚Äî –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å, –Ω–æ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π
- `Rc::clone` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç `strong`
- `Rc::drop` —É–º–µ–Ω—å—à–∞–µ—Ç `strong`, –∏ –µ—Å–ª–∏ –æ–Ω —Ä–∞–≤–µ–Ω `0` ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç `drop(value)`

## üß™ –ü–æ–≤–µ–¥–µ–Ω–∏–µ: clone, drop (–ø—Å–µ–≤–¥–æ–∫–æ–¥)

### `clone()`
```rust
fn clone(&self) -> Rc<T> {
    self.ptr.strong += 1;  // —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ —Å–∏–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ 1
    Rc { ptr: self.ptr }  // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
}
```

### `drop()`
```rust
fn drop(&mut self) {
    self.ptr.strong -= 1;  // —É–º–µ–Ω—å—à–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —Å–∏–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ 1
    if self.ptr.strong == 0 {  // ... –∏ –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞...
        drop(self.ptr.value);  // ... —Ç–æ —É–¥–∞–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
        self.ptr.weak -= 1;
        if self.ptr.weak == 0 {
            dealloc(self.ptr);
        }
    }
}
```

## üìå –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Rc::new? (–ø—Å–µ–≤–¥–æ–∫–æ–¥)

```rust
pub fn new(value: T) -> Rc<T> {
    let box_ptr = Box::new(RcBox {
        strong: Cell::new(1),
        weak: Cell::new(1), // –Ω–∞—á–∞–ª—å–Ω–æ weak = 1 (–Ω–∞ —Å–µ–±—è)
        value,
    });

    Rc {
        ptr: Box::into_raw(box_ptr),
    }
}
```

> weak = 1 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –±–ª–æ–∫ –ø–∞–º—è—Ç–∏ –∂–∏–≤ –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –∂–∏–≤—ã –ª–∏–±–æ `Rc`, –ª–∏–±–æ `Weak`.

## üß™ –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ —Å –ø–æ–¥—Å—á—ë—Ç–æ–º

```rust
use std::rc::Rc;

fn main() {
    let a = Rc::new("hello".to_string());

    println!("strong = {}", Rc::strong_count(&a)); // 1

    let b = Rc::clone(&a);
    println!("strong = {}", Rc::strong_count(&a)); // 2

    {
        let c = Rc::clone(&a);
        println!("strong = {}", Rc::strong_count(&a)); // 3
    }

    println!("strong = {}", Rc::strong_count(&a)); // 2
}

```

## –°–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Å—ã–ª–∫–∏

### üî¥ –°–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (Rc<T>)
–°–∏–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ (strong reference) ‚Äî —ç—Ç–æ –≤–ª–∞–¥–µ–ª—å—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞:
- –•—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ `Rc<T>`.
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ `strong`.
- –ü–æ–∫–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å–∏–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –æ–±—ä–µ–∫—Ç –Ω–µ –±—É–¥–µ—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω.
- –ö–æ–≥–¥–∞ —Å—á—ë—Ç—á–∏–∫ `strong` –¥–æ—Å—Ç–∏–≥–∞–µ—Ç `0` ‚Äî –æ–±—ä–µ–∫—Ç (`T`) —É–¥–∞–ª—è–µ—Ç—Å—è.

#### üì¶ –ü—Ä–∏–º–µ—Ä
```rust
let a = Rc::new("hello".to_string());  // —Å–∏–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
let b = a.clone(); // –µ—â—ë –æ–¥–Ω–∞ —Å–∏–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
```
üß† –ó–¥–µ—Å—å a –∏ b –æ–±–∞ –≤–ª–∞–¥–µ—é—Ç —Å—Ç—Ä–æ–∫–æ–π. –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç, —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ–±–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.


### üü° –°–ª–∞–±—ã–µ —Å—Å—ã–ª–∫–∏ (Weak<T>)
–°–ª–∞–±–∞—è —Å—Å—ã–ª–∫–∞ (weak reference) ‚Äî —ç—Ç–æ –Ω–µ–≤–ª–∞–¥–µ–ª—å—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞:
- –•—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ `Weak<T>`, —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ `Rc::downgrade(&rc)`.
- –ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç `strong`-—Å—á—ë—Ç—á–∏–∫.
- –ù–µ –º–µ—à–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏—é –æ–±—ä–µ–∫—Ç–∞.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –∏–ª–∏ –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–æ–≤.
- –ú–æ–∂–µ—Ç –±—ã—Ç—å "–ø—É—Å—Ç–æ–π", –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç —É–∂–µ —É–Ω–∏—á—Ç–æ–∂–µ–Ω.

#### üì¶ –ü—Ä–∏–º–µ—Ä
```rust
let strong = Rc::new("hello".to_string());
let weak = Rc::downgrade(&strong);
```

### –û—Ç–ª–∏—á–∏—è –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

| –°–≤–æ–π—Å—Ç–≤–æ                 | `Rc<T>` (—Å–∏–ª—å–Ω–∞—è)     | `Weak<T>` (—Å–ª–∞–±–∞—è)       |
| ------------------------ | --------------------- | ------------------------ |
| –í–ª–∞–¥–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–º        | ‚úÖ –î–∞                  | ‚ùå –ù–µ—Ç                    |
| –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –∂–∏–∑–Ω—å –æ–±—ä–µ–∫—Ç–∞ | ‚úÖ –î–∞                  | ‚ùå –ù–µ—Ç                    |
| –°—á—ë—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è    | `strong += 1`         | `weak += 1`              |
| –û–±—ä–µ–∫—Ç —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏...  | `strong == 0`         | –ù–µ –≤–ª–∏—è–µ—Ç                |
| –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º          | `*rc` (—Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–µ) | –¢–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `upgrade()` |
| –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è...      | –í–ª–∞–¥–µ—é—â–∏—Ö —Å—Å—ã–ª–æ–∫      | –û–±—Ä–∞—Ç–Ω—ã—Ö/–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π    |
| –¢–∏–ø                      | `Rc<T>`               | `Weak<T>`                |


### üï∏ –ü—Ä–∏–º–µ—Ä: –¥–µ—Ä–µ–≤–æ –±–µ–∑ —É—Ç–µ—á–µ–∫
```rust
use std::rc::{Rc, Weak};
use std::cell::RefCell;

struct Node {
    name: String,
    parent: RefCell<Option<Weak<Node>>>, // —Å–ª–∞–±–∞—è —Å—Å—ã–ª–∫–∞ (—Ä–µ–±—ë–Ω–æ–∫ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–ª–∞–¥–µ—Ç—å —Ä–æ–¥–∏—Ç–µ–ª–µ–º)
    children: RefCell<Vec<Rc<Node>>>,    // —Å–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (—É–∑–ª—ã –≤–ª–∞–¥–µ—é—Ç –ø–æ—Ç–æ–º–∫–∞–º–∏)
}

```
